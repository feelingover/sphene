---
applyTo: "**"
---
# Important Note
This file is a part of the Memory Bank. It provides essential context for understanding the project.
Claude Code should reference this file when working on related tasks, but doesn't need to read it every time due to conversation context continuity.

# 🚀 Sphene Discord Bot アクティブコンテキスト

## 現在の焦点

Sphene Discord BotはXIVAPI v2 Function Callingによるアイテム検索機能の拡張を進めています。ジョブ・アイテムレベル指定の検索条件が追加され、「竜騎士のIL500から550の装備」のような複合条件検索が可能になりました。全137テストが通過し、テストカバレッジは86%を維持しています。

## 最近の変更

### 2026/2: XIVAPI Function Calling 検索条件拡張
既存の`search_item`ツールにジョブ名(`class_job`)・アイテムレベル範囲(`ilvl_min`/`ilvl_max`)パラメータを追加。日本語ジョブ名/英語略称の両方に対応。フィルタ検索時はlimit=20、名前のみ検索時はlimit=5の動的制御を実装。34件の新規テストを追加。

### 2025/12/7: 大規模リファクタリング完了
セキュリティ修正(エラーメッセージ情報漏洩対策)、コード重複30%削減(翻訳関数統合)、関数分割(60行→3関数)、命名規約統一(private関数に`_`)、エラーログ詳細化(`exc_info=True`追加)を実施。全103テスト通過、カバレッジ86%維持。詳細は[CLAUDE.md](../../CLAUDE.md)の「Recent Refactoring」参照。

## 進行中のタスク

1. **メモリーバンクの整備と活用**
   - 開発履歴や決定事項の記録
   - 技術的知見の蓄積

2. **品質向上**
   - ロバスト性の向上
   - エラー処理の洗練
   - コード品質の改善

## 次のステップ

1. **ユーザーフィードバックの収集**
   - 実際の使用状況での課題識別
   - 要望の収集と優先順位付け

2. **機能拡張候補**
   - チャンネル固有のプロンプト設定
   - 使用統計の収集と分析
   - パフォーマンス最適化

3. **インフラ改善**
   - CI/CDパイプラインの強化
   - モニタリングと自動アラート
   - スケーリング戦略の最適化

## 重要な決定事項

### 2026/2: XIVAPI検索条件拡張関連決定

1. **後方互換性の維持**
   - **決定**: `search_item()`の全パラメータにデフォルト値を設定し、既存呼び出しをそのまま動作させる
   - **理由**: `ai/conversation.py`の`func(**arguments)`による動的呼び出しとの互換性維持

2. **ジョブ名解決の二段階方式**
   - **決定**: 日本語名→略称マッピングと英語略称バリデーションの二段階で解決
   - **理由**: ユーザーが日本語名・英語略称どちらでも指定できる柔軟性の確保

3. **動的limit制御**
   - **決定**: フィルタ検索時はlimit=20、名前のみ検索時はlimit=5
   - **理由**: フィルタ検索は広い結果を期待するため、より多くの結果を返す

### 2025/12/7: リファクタリング関連決定

1. **後方互換性の扱い**
   - **決定**: 後方互換コードの削除を許可し、クリーンな実装を優先
   - **理由**: 保守性とコード品質を最優先
   - **実践**: 既存の翻訳関数をラッパー化することで互換性を保ちつつ実装を統合

2. **セキュリティ優先のエラーメッセージ設計**
   - **決定**: ユーザー向けエラーメッセージから内部詳細を完全に除外
   - **理由**: 情報漏洩リスクの低減、攻撃面の最小化
   - **実践**: 一般的なエラーメッセージをユーザーに提示、詳細はログのみに記録

3. **関数長の基準**
   - **決定**: 1関数あたり20-30行を目安に、60行を超える関数は分割
   - **理由**: 単一責任原則、可読性、テスト容易性
   - **実践**: `load_system_prompt()`を3つの関数に分割

4. **命名規約の厳格化**
   - **決定**: 内部専用関数には必ずアンダースコアプレフィックス(`_`)を付ける
   - **理由**: public/privateの区別を明確化、APIの意図を明示
   - **影響範囲**: テストコードも同時に更新

5. **ログレベルの詳細度**
   - **決定**: エラーログには常に`exc_info=True`を追加してスタックトレースを記録
   - **理由**: デバッグ効率の最大化、問題解決時間の短縮
   - **影響**: 本番環境でのトラブルシューティングが大幅に改善

### 過去の設計決定

1. **ストレージ戦略**: ローカル/S3選択、環境変数切り替え
2. **エラー処理**: 階層的ハンドリング、ユーザーフレンドリーメッセージ、詳細ログ
3. **設計パターン**: 詳細は[systemPatterns.md](systemPatterns.md)参照

## 技術的課題と解決方法

1. **会話コンテキスト管理**
   - **課題**: 長時間の会話履歴によるトークン数増加とコスト増
   - **解決策**: タイムアウトメカニズムと最大ターン数制限の実装

2. **画像処理**
   - **課題**: DiscordからOpenAI APIへの画像データ転送
   - **解決策**: URLアクセスとBase64エンコードの自動フォールバック

3. **エラー回復**
   - **課題**: OpenAI API障害時のサービス安定性
   - **解決策**: エラータイプ別の処理戦略とユーザーフレンドリーなフォールバック

4. **設定管理**
   - **課題**: 複数の環境での一貫した設定
   - **解決策**: 環境変数とdotenvによる設定の集中管理

## パターンとプラクティス

1. **モジュール分割**: 責務別分割、レイヤー間依存最小化
2. **型安全性**: Python型ヒント、明示的型キャスト
3. **テスト戦略**: ユニットテスト、モック使用
4. **エラー処理**: タイプ別マッピング、メッセージ/ログ分離
5. **設定柔軟性**: 環境変数、ストレージ抽象化

## Claude Code活用ガイドライン

### 複雑なタスクの場合

1. **TodoWriteツールを活用**
   - 複数ステップのタスクを可視化
   - 進捗をユーザーに明示
   - タスクの漏れを防止

2. **Plan Modeで設計を先に完了**
   - Exploreエージェントでコードベース理解
   - 詳細な実装プランを作成
   - ユーザー承認後に実装開始

3. **段階的に実装を進める**
   - 一度に大量の変更を避ける
   - テストを実行しながら進める
   - エラーが出たらすぐに対処

### 最新情報が必要な場合

- **WebSearch**を活用して公式ドキュメントを確認
- 依存パッケージのバージョン情報を取得
- 新しいベストプラクティスを調査

### 大規模リファクタリングの場合

1. Plan Modeで影響範囲を分析
2. TodoWriteでタスクを分割
3. 段階的にレビューしながら進める
4. 各ステップでテストを実行
5. Memory Bankを更新(決定事項、パターン)

## 学びと洞察

1. **Discord.py**: イベント/コマンド処理の効率的実装
2. **OpenAI API**: コンテキスト管理、コスト/パフォーマンスバランス
3. **エラーハンドリング**: UX重視、適切なログレベル
4. **設定管理**: 環境一貫性、拡張性考慮
