name: "Build and push"

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  INFRA_REPO: https://github.com/feelingover/sphene-infra.git

on:
  push:
    branches: ['main']

jobs:
  build:
    name: "Build and push"
    runs-on: ubuntu-latest

    permissions:
        contents: read
        packages: write
        attestations: write
        id-token: write
        models: read

    steps:

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest
            type=raw,value=build-${{ github.run_number }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          push: true
          context: .
          platforms: linux/arm64,linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          
      - name: Extract image tag
        id: extract-tag
        run: |
          echo "IMAGE_TAG=build-${{ github.run_number }}" >> $GITHUB_OUTPUT
          
      - name: Get last commit message
        id: last-commit
        run: |
          echo "message<<EOF" >> $GITHUB_OUTPUT
          git log -1 --pretty=%B >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # ğŸ¤– AI generated PR title
      - name: Generate PR title with AI
        id: ai-title
        run: |
          COMMIT_MSG="${{ steps.last-commit.outputs.message }}"
          IMAGE_TAG="${{ steps.extract-tag.outputs.IMAGE_TAG }}"
          
          # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ”¹è¡Œãƒ»ç‰¹æ®Šæ–‡å­—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
          ESCAPED_COMMIT_MSG=$(echo "$COMMIT_MSG" | tr -d '\n\r' | sed 's/"/\\"/g' | sed "s/'/\\'/g")
          ESCAPED_IMAGE_TAG=$(echo "$IMAGE_TAG" | sed 's/"/\\"/g')
          
          echo "ğŸ¤– AIã«PRã‚¿ã‚¤ãƒˆãƒ«ã‚’è€ƒãˆã¦ã‚‚ã‚‰ã£ã¦ã„ã¾ã™..."
          
          # JSONãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’æ§‹ç¯‰ï¼ˆjqã‚’ä½¿ã£ã¦å®‰å…¨ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼‰
          JSON_PAYLOAD=$(jq -n \
            --arg model "openai/gpt-4.1" \
            --arg content "GitOpsã®ãƒ‡ãƒ—ãƒ­ã‚¤PRã‚¿ã‚¤ãƒˆãƒ«ã‚’ä½œã£ã¦ã€‚ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: $ESCAPED_COMMIT_MSGã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°: $ESCAPED_IMAGE_TAGã€‚ã¯ã¦ãªãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã§ãƒã‚ºã‚Šãã†ãªé¢ç™½ã„ã‚¿ã‚¤ãƒˆãƒ«ã‚’1è¡Œã§ã€‚çµµæ–‡å­—ã‚‚ä½¿ã£ã¦ï¼" \
            '{
              "model": $model,
              "messages": [
                {
                  "role": "user",
                  "content": $content
                }
              ]
            }')
          
          # GitHub Models APIã‚’å‘¼ã³å‡ºã—
          echo "DEBUG: Calling GitHub Models API..."
          TITLE_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" "https://models.github.ai/inference/chat/completions" \
             -H "Accept: application/vnd.github+json" \
             -H "Authorization: Bearer $GITHUB_TOKEN" \
             -H "X-GitHub-Api-Version: 2022-11-28" \
             -H "Content-Type: application/json" \
             -d "$JSON_PAYLOAD")
          
          echo "DEBUG: Raw API response:"
          echo "$TITLE_RESPONSE"
          
          # HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèª
          HTTP_CODE=$(echo "$TITLE_RESPONSE" | grep "HTTP_CODE:" | tail -1 | cut -d: -f2)
          RESPONSE_BODY=$(echo "$TITLE_RESPONSE" | sed '/HTTP_CODE:/d')
          
          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒæ­£å¸¸ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆè©³ç´°ãªãƒ‡ãƒãƒƒã‚°ä»˜ãï¼‰
          if [[ "$HTTP_CODE" == "200" ]]; then
            echo "âœ… HTTP Status is 200, checking JSON validity..."
            if echo "$RESPONSE_BODY" | jq empty 2>/dev/null; then
              echo "âœ… JSON is valid, extracting content..."
              AI_TITLE=$(echo "$RESPONSE_BODY" | jq -r '.choices[0].message.content // "ğŸš€æ–°ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆ '"$IMAGE_TAG"'"' | head -1)
              echo "âœ… API call successful!"
            else
              echo "âŒ JSON validation failed:"
              echo "$RESPONSE_BODY" | jq empty 2>&1 || true
              AI_TITLE="ğŸš€æ–°ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆ $IMAGE_TAG"
            fi
          else
            echo "âŒ API call failed (Status: $HTTP_CODE). Using fallback title."
            AI_TITLE="ğŸš€æ–°ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆ $IMAGE_TAG"
          fi
          
          echo "Generated title: $AI_TITLE"
          echo "title<<EOF" >> $GITHUB_OUTPUT
          echo "$AI_TITLE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # ğŸ¤– AI generated PR body
      - name: Generate PR body with AI
        id: ai-body
        run: |
          COMMIT_MSG="${{ steps.last-commit.outputs.message }}"
          IMAGE_TAG="${{ steps.extract-tag.outputs.IMAGE_TAG }}"
          BUILD_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # æ”¹è¡Œãƒ»ç‰¹æ®Šæ–‡å­—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
          ESCAPED_COMMIT_MSG=$(echo "$COMMIT_MSG" | tr -d '\n\r' | sed 's/"/\\"/g' | sed "s/'/\\'/g")
          
          echo "ğŸ¤– AIã«PRèª¬æ˜æ–‡ã‚’è€ƒãˆã¦ã‚‚ã‚‰ã£ã¦ã„ã¾ã™..."
          
          # JSONãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’æ§‹ç¯‰
          JSON_PAYLOAD=$(jq -n \
            --arg model "openai/gpt-4.1" \
            --arg content "GitOpsã®ãƒ‡ãƒ—ãƒ­ã‚¤PRã®èª¬æ˜æ–‡ã‚’ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã§ä½œã£ã¦ã€‚æ¥½ã—ã„æ„Ÿã˜ã§ï¼\n\nã‚³ãƒŸãƒƒãƒˆå†…å®¹: $ESCAPED_COMMIT_MSG\nã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°: $IMAGE_TAG\nãƒ“ãƒ«ãƒ‰URL: $BUILD_URL\n\nä»¥ä¸‹ã®æƒ…å ±ã‚’å«ã‚ã¦ã­:\n- ğŸ·ï¸ ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°\n- ğŸ“ å¤‰æ›´å†…å®¹\n- ğŸ”¨ ãƒ“ãƒ«ãƒ‰ãƒªãƒ³ã‚¯\n- ãƒãƒ¼ã‚¸ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚‚ã‚‰ã†ãŠé¡˜ã„\n\næ¯å›é•ã†ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ã§æ›¸ã„ã¦ï¼" \
            '{
              "model": $model,
              "messages": [
                {
                  "role": "user",
                  "content": $content
                }
              ]
            }')

          BODY_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" "https://models.github.ai/inference/chat/completions" \
             -H "Accept: application/vnd.github+json" \
             -H "Authorization: Bearer $GITHUB_TOKEN" \
             -H "X-GitHub-Api-Version: 2022-11-28" \
             -H "Content-Type: application/json" \
             -d "$JSON_PAYLOAD")

          # HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèª
          HTTP_CODE=$(echo "$BODY_RESPONSE" | grep "HTTP_CODE:" | tail -1 | cut -d: -f2)
          RESPONSE_BODY=$(echo "$BODY_RESPONSE" | sed '/HTTP_CODE:/d')
          
          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒæ­£å¸¸ã‹ãƒã‚§ãƒƒã‚¯
          if [[ "$HTTP_CODE" == "200" ]]; then
            echo "âœ… Body HTTP Status is 200, checking JSON validity..."
            if echo "$RESPONSE_BODY" | jq empty 2>/dev/null; then
              echo "âœ… Body JSON is valid, extracting content..."
              AI_BODY=$(echo "$RESPONSE_BODY" | jq -r '.choices[0].message.content // "### æ–°ã—ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒããŸã‚ˆï¼\n\nğŸš€ ãƒãƒ¼ã‚¸ã—ãŸã‚‰æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ï¼\n\n#### ğŸ“ æ›´æ–°å†…å®¹\n- '"$ESCAPED_COMMIT_MSG"'\n- ğŸ·ï¸ ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°: `'"$IMAGE_TAG"'`\n- ğŸ”¨ ãƒ“ãƒ«ãƒ‰: '"$BUILD_URL"'"')
              echo "âœ… Body API call successful!"
            else
              echo "âŒ Body JSON validation failed:"
              echo "$RESPONSE_BODY" | jq empty 2>&1 || true
              AI_BODY="### æ–°ã—ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒããŸã‚ˆï¼\n\nğŸš€ ãƒãƒ¼ã‚¸ã—ãŸã‚‰æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ï¼\n\n#### ğŸ“ æ›´æ–°å†…å®¹\n- $ESCAPED_COMMIT_MSG\n- ğŸ·ï¸ ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°: \`$IMAGE_TAG\`\n- ğŸ”¨ ãƒ“ãƒ«ãƒ‰: $BUILD_URL\n\nå•é¡Œãªã•ãã†ã ã£ãŸã‚‰ãƒãƒ¼ã‚¸ãƒœã‚¿ãƒ³æŠ¼ã—ã¡ã‚ƒã£ã¦ã€œï¼"
            fi
          else
            echo "âŒ Body API call failed (Status: $HTTP_CODE). Using fallback body."
            AI_BODY="### æ–°ã—ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒããŸã‚ˆï¼\n\nğŸš€ ãƒãƒ¼ã‚¸ã—ãŸã‚‰æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ï¼\n\n#### ğŸ“ æ›´æ–°å†…å®¹\n- $ESCAPED_COMMIT_MSG\n- ğŸ·ï¸ ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°: \`$IMAGE_TAG\`\n- ğŸ”¨ ãƒ“ãƒ«ãƒ‰: $BUILD_URL\n\nå•é¡Œãªã•ãã†ã ã£ãŸã‚‰ãƒãƒ¼ã‚¸ãƒœã‚¿ãƒ³æŠ¼ã—ã¡ã‚ƒã£ã¦ã€œï¼"
          fi
          
          echo "Generated body:"
          echo "$AI_BODY"
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$AI_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Checkout infrastructure repository
        uses: actions/checkout@v4
        with:
          repository: feelingover/sphene-infra
          path: infra
          token: ${{ secrets.PAT_TOKEN }}
          
      - name: Update deployment.yaml with new image tag
        run: |
          cd infra
          IMAGE_TAG=${{ steps.extract-tag.outputs.IMAGE_TAG }}
          DEPLOYMENT_FILE="environments/prod/deployment.yaml"
          
          # Replace the image tag in deployment.yaml
          sed -i -e "s|image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:.*|image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}|g" $DEPLOYMENT_FILE
          

      - name: Create Pull Request with AI-generated content
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.PAT_TOKEN }}
          path: infra
          commit-message: Update image to ${{ steps.extract-tag.outputs.IMAGE_TAG }}
          branch: update-image-${{ steps.extract-tag.outputs.IMAGE_TAG }}
          title: ${{ steps.ai-title.outputs.title }}
          body: ${{ steps.ai-body.outputs.body }}
