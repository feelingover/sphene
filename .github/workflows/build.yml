name: "Build and push"

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  INFRA_REPO: https://github.com/feelingover/sphene-infra.git

on:
  push:
    branches: ['main']

jobs:
  build:
    name: "Build and push"
    runs-on: ubuntu-latest

    permissions:
        contents: read
        packages: write
        attestations: write
        id-token: write
        models: read

    steps:

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest
            type=raw,value=build-${{ github.run_number }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          push: true
          context: .
          platforms: linux/arm64,linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          
      - name: Extract image tag
        id: extract-tag
        run: |
          echo "IMAGE_TAG=build-${{ github.run_number }}" >> $GITHUB_OUTPUT
          
      - name: Get last commit message
        id: last-commit
        run: |
          echo "message<<EOF" >> $GITHUB_OUTPUT
          git log -1 --pretty=%B >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # ğŸ¤– AI generated PR title
      - name: Generate PR title with AI
        id: ai-title
        run: |
          COMMIT_MSG="${{ steps.last-commit.outputs.message }}"
          IMAGE_TAG="${{ steps.extract-tag.outputs.IMAGE_TAG }}"
          
          echo "ğŸ¤– AIã«PRã‚¿ã‚¤ãƒˆãƒ«ã‚’è€ƒãˆã¦ã‚‚ã‚‰ã£ã¦ã„ã¾ã™..."
          
          TITLE_RESPONSE=$(curl -s "https://models.github.ai/inference/chat/completions" \
             -H "Content-Type: application/json" \
             -H "Authorization: Bearer $GITHUB_TOKEN" \
             -d '{
              "messages": [
                  {
                     "role": "user",
                     "content": "GitOpsã®ãƒ‡ãƒ—ãƒ­ã‚¤PRã‚¿ã‚¤ãƒˆãƒ«ã‚’ä½œã£ã¦ã€‚ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: '"$COMMIT_MSG"'ã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°: '"$IMAGE_TAG"'ã€‚ã¯ã¦ãªãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã§ãƒã‚ºã‚Šãã†ãªé¢ç™½ã„ã‚¿ã‚¤ãƒˆãƒ«ã‚’1è¡Œã§ã€‚çµµæ–‡å­—ã‚‚ä½¿ã£ã¦ï¼"
                  }
               ],
               "model": "openai/gpt-4.1"
            }' || echo '{"choices":[{"message":{"content":"ğŸš€æ–°ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆ '"$IMAGE_TAG"'"}}]}')

          # JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«ã‚’æŠ½å‡º
          AI_TITLE=$(echo "$TITLE_RESPONSE" | jq -r '.choices[0].message.content // "ğŸš€æ–°ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆ '"$IMAGE_TAG"'"' | head -1)
          
          echo "Generated title: $AI_TITLE"
          echo "title<<EOF" >> $GITHUB_OUTPUT
          echo "$AI_TITLE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # ğŸ¤– AI generated PR body
      - name: Generate PR body with AI
        id: ai-body
        run: |
          COMMIT_MSG="${{ steps.last-commit.outputs.message }}"
          IMAGE_TAG="${{ steps.extract-tag.outputs.IMAGE_TAG }}"
          BUILD_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          echo "ğŸ¤– AIã«PRèª¬æ˜æ–‡ã‚’è€ƒãˆã¦ã‚‚ã‚‰ã£ã¦ã„ã¾ã™..."
          
          BODY_RESPONSE=$(curl -s "https://models.github.ai/inference/chat/completions" \
             -H "Content-Type: application/json" \
             -H "Authorization: Bearer $GITHUB_TOKEN" \
             -d '{
              "messages": [
                  {
                     "role": "user",
                     "content": "GitOpsã®ãƒ‡ãƒ—ãƒ­ã‚¤PRã®èª¬æ˜æ–‡ã‚’ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã§ä½œã£ã¦ã€‚æ¥½ã—ã„æ„Ÿã˜ã§ï¼\n\nã‚³ãƒŸãƒƒãƒˆå†…å®¹: '"$COMMIT_MSG"'\nã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°: '"$IMAGE_TAG"'\nãƒ“ãƒ«ãƒ‰URL: '"$BUILD_URL"'\n\nä»¥ä¸‹ã®æƒ…å ±ã‚’å«ã‚ã¦ã­:\n- ğŸ·ï¸ ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°\n- ğŸ“ å¤‰æ›´å†…å®¹\n- ğŸ”¨ ãƒ“ãƒ«ãƒ‰ãƒªãƒ³ã‚¯\n- ãƒãƒ¼ã‚¸ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚‚ã‚‰ã†ãŠé¡˜ã„\n\næ¯å›é•ã†ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ã§æ›¸ã„ã¦ï¼"
                  }
               ],
               "model": "openai/gpt-4.1"
            }' || echo '{"choices":[{"message":{"content":"### ï¼¼ï¾œï½§ï½°ï½²ãƒ½(â™¡Â´âˆ€`)ï¾‰â™¡ï¼ æ–°ã—ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒããŸã‚ˆï¼\n\nğŸš€ ãƒãƒ¼ã‚¸ã—ãŸã‚‰æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¡ã‚ƒã†ã‹ã‚‰ã­ï¼\n\n#### ğŸ“ æ›´æ–°å†…å®¹\n- '"$COMMIT_MSG"'\n- ğŸ·ï¸ ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°: `'"$IMAGE_TAG"'`\n- ğŸ”¨ ãƒ“ãƒ«ãƒ‰: '"$BUILD_URL"'\n\nå•é¡Œãªã•ãã†ã ã£ãŸã‚‰ãƒãƒ¼ã‚¸ãƒœã‚¿ãƒ³æŠ¼ã—ã¡ã‚ƒã£ã¦ã€œï¼"}}]}')

          # JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰æœ¬æ–‡ã‚’æŠ½å‡º
          AI_BODY=$(echo "$BODY_RESPONSE" | jq -r '.choices[0].message.content // "### æ–°ã—ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒããŸã‚ˆï¼\n\nğŸš€ ãƒãƒ¼ã‚¸ã—ãŸã‚‰æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ï¼\n\n#### ğŸ“ æ›´æ–°å†…å®¹\n- '"$COMMIT_MSG"'\n- ğŸ·ï¸ ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°: `'"$IMAGE_TAG"'`\n- ğŸ”¨ ãƒ“ãƒ«ãƒ‰: '"$BUILD_URL"'"')
          
          echo "Generated body:"
          echo "$AI_BODY"
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$AI_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Checkout infrastructure repository
        uses: actions/checkout@v4
        with:
          repository: feelingover/sphene-infra
          path: infra
          token: ${{ secrets.PAT_TOKEN }}
          
      - name: Update deployment.yaml with new image tag
        run: |
          cd infra
          IMAGE_TAG=${{ steps.extract-tag.outputs.IMAGE_TAG }}
          DEPLOYMENT_FILE="environments/prod/deployment.yaml"
          
          # Replace the image tag in deployment.yaml
          sed -i -e "s|image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:.*|image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}|g" $DEPLOYMENT_FILE
          

      - name: Create Pull Request with AI-generated content
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.PAT_TOKEN }}
          path: infra
          commit-message: Update image to ${{ steps.extract-tag.outputs.IMAGE_TAG }}
          branch: update-image-${{ steps.extract-tag.outputs.IMAGE_TAG }}
          title: ${{ steps.ai-title.outputs.title }}
          body: ${{ steps.ai-body.outputs.body }}
